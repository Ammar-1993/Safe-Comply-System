<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Settings - Compliance Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/pages.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}" />
</head>

<body>
  <div class="dashboard-wrapper">
    {% set active_page = 'settings' %}
    {% include 'components/sidebar.html' %}

    <div class="main-content">
      {% set page_title = 'Settings' %}
      {% include 'components/navbar.html' %}

      <div class="content-area">
        <div class="section-title">General Settings</div>

        <div class="settings-grid">
          <!-- Account Settings -->
          <div class="settings-card">
            <div class="settings-card-title">Account Settings</div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Username</div>
                <div class="setting-description">Change your username</div>
              </div>
              <div class="setting-control">
                <input type="text" class="setting-input" id="usernameInput" value="Admin" readonly />
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Email Address</div>
                <div class="setting-description">
                  Update your email address
                </div>
              </div>
              <div class="setting-control">
                <input type="email" class="setting-input" id="emailInput" value="admin@company.com" />
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Password</div>
                <div class="setting-description">Change your password</div>
              </div>
              <div class="setting-control">
                <button class="btn-secondary" id="changePasswordBtn">Change Password</button>
              </div>
            </div>

            <div class="button-group">
              <button class="btn-primary" id="saveChangesBtn">Save Changes</button>
              <button class="btn-secondary" id="cancelBtn">Cancel</button>
            </div>
          </div>

          <!-- Notification Settings -->
          <div class="settings-card">
            <div class="settings-card-title">Notification Settings</div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Email Notifications</div>
                <div class="setting-description">
                  Receive email notifications for alerts
                </div>
              </div>
              <div class="setting-control">
                <div class="toggle-switch active" onclick="toggleSwitch(this)">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Push Notifications</div>
                <div class="setting-description">
                  Receive push notifications
                </div>
              </div>
              <div class="setting-control">
                <div class="toggle-switch active" onclick="toggleSwitch(this)">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Weekly Reports</div>
                <div class="setting-description">
                  Receive weekly compliance reports
                </div>
              </div>
              <div class="setting-control">
                <div class="toggle-switch" onclick="toggleSwitch(this)">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Alert Priority</div>
                <div class="setting-description">
                  Minimum priority level for notifications
                </div>
              </div>
              <div class="setting-control">
                <select class="setting-select">
                  <option>All Alerts</option>
                  <option selected>Medium and High</option>
                  <option>High Only</option>
                </select>
              </div>
            </div>
          </div>

          <!-- System Settings -->
          <div class="settings-card">
            <div class="settings-card-title">System Settings</div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Language</div>
                <div class="setting-description">
                  Choose your preferred language
                </div>
              </div>
              <div class="setting-control">
                <select class="setting-select">
                  <option selected>English</option>
                  <option>Arabic</option>
                  <option>French</option>
                  <option>Spanish</option>
                </select>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Time Zone</div>
                <div class="setting-description">Set your time zone</div>
              </div>
              <div class="setting-control">
                <select class="setting-select">
                  <option>UTC</option>
                  <option selected>GMT+3 (Riyadh)</option>
                  <option>GMT+0 (London)</option>
                  <option>EST (New York)</option>
                </select>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Dark Mode</div>
                <div class="setting-description">Enable dark mode theme</div>
              </div>
              <div class="setting-control">
                <div class="toggle-switch" onclick="toggleSwitch(this)">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Auto Backup</div>
                <div class="setting-description">
                  Automatically backup data daily
                </div>
              </div>
              <div class="setting-control">
                <div class="toggle-switch active" onclick="toggleSwitch(this)">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Security Settings -->
          <div class="settings-card">
            <div class="settings-card-title">Security Settings</div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Two-Factor Authentication</div>
                <div class="setting-description">
                  Add an extra layer of security
                </div>
              </div>
              <div class="setting-control">
                <div class="toggle-switch" onclick="toggleSwitch(this)">
                  <div class="toggle-slider"></div>
                </div>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Session Timeout</div>
                <div class="setting-description">
                  Auto logout after inactivity
                </div>
              </div>
              <div class="setting-control">
                <select class="setting-select">
                  <option>15 minutes</option>
                  <option selected>30 minutes</option>
                  <option>1 hour</option>
                  <option>Never</option>
                </select>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Login History</div>
                <div class="setting-description">
                  View your recent login activity
                </div>
              </div>
              <div class="setting-control">
                <button class="btn-secondary" id="viewHistoryBtn">View History</button>
              </div>
            </div>
          </div>

          <!-- User Management (Admin Only) -->
          <div class="settings-card" id="userManagementSection" style="display: none;">
            <div class="settings-card-title">User Management (Admin)</div>
            <div id="userListContainer">
              <div style="text-align: center; color: #666;">Loading users...</div>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="settings-card" style="border: 2px solid #e74c3c">
            <div class="settings-card-title" style="color: #e74c3c">
              Danger Zone
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Export Data</div>
                <div class="setting-description">Download all your data</div>
              </div>
              <div class="setting-control">
                <button class="btn-secondary" id="exportBtn">Export</button>
              </div>
            </div>

            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">Delete Account</div>
                <div class="setting-description">
                  Permanently delete your account and all data
                </div>
              </div>
              <div class="setting-control">
                <button class="btn-danger" id="deleteAccountBtn">Delete Account</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Change Password Modal -->
  <div id="passwordModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div style="background:white; padding:30px; border-radius:12px; width:400px; max-width:90%;">
      <h3 style="margin:0 0 20px; color:#051338;">Change Password</h3>
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#2c3e50;">Current Password</label>
        <div style="position: relative;">
          <input type="password" id="currentPassword"
            style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:6px; box-sizing:border-box;" />
          <span class="password-toggle" onclick="togglePassword('currentPassword', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </span>
        </div>
      </div>
      <div style="margin-bottom:15px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#2c3e50;">New Password</label>
        <div style="position: relative;">
          <input type="password" id="newPassword"
            style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:6px; box-sizing:border-box;" />
          <span class="password-toggle" onclick="togglePassword('newPassword', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </span>
        </div>
      </div>
      <div style="margin-bottom:20px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#2c3e50;">Confirm New Password</label>
        <div style="position: relative;">
          <input type="password" id="confirmPassword"
            style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:6px; box-sizing:border-box;" />
          <span class="password-toggle" onclick="togglePassword('confirmPassword', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </span>
        </div>
      </div>
      <div id="passwordRequirements"
        style="margin-bottom:15px; padding:10px; background:#f8f9fa; border-radius:6px; font-size:12px; color:#666;">
        Password must be at least 12 characters with uppercase, lowercase, number, and special character.
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button onclick="closePasswordModal()" class="btn-secondary">Cancel</button>
        <button onclick="submitPasswordChange()" class="btn-primary">Change Password</button>
      </div>
    </div>
  </div>

  <!-- Login History Modal -->
  <div id="historyModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div
      style="background:white; padding:30px; border-radius:12px; width:600px; max-width:90%; max-height:80vh; overflow-y:auto;">
      <h3 style="margin:0 0 20px; color:#051338;">Login History</h3>
      <div id="historyContent" style="min-height:100px;">
        <div style="text-align:center; color:#666;">Loading...</div>
      </div>
      <div style="display:flex; justify-content:flex-end; margin-top:20px;">
        <button onclick="closeHistoryModal()" class="btn-secondary">Close</button>
      </div>
    </div>
  </div>

  <!-- Delete Account Modal -->
  <div id="deleteModal"
    style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center;">
    <div
      style="background:white; padding:30px; border-radius:12px; width:400px; max-width:90%; border:2px solid #e74c3c;">
      <h3 style="margin:0 0 20px; color:#e74c3c;">⚠️ Delete Account</h3>
      <p style="color:#666; margin-bottom:20px;">This action is permanent and cannot be undone. All your data and
        reports will be deleted.</p>
      <div style="margin-bottom:20px;">
        <label style="display:block; margin-bottom:5px; font-weight:600; color:#2c3e50;">Enter your password to
          confirm</label>
        <div style="position: relative;">
          <input type="password" id="deletePassword"
            style="width:100%; padding:10px; border:1px solid #dee2e6; border-radius:6px; box-sizing:border-box;" />
          <span class="password-toggle" onclick="togglePassword('deletePassword', this)">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></svg>
          </span>
        </div>
      </div>
      <div style="display:flex; gap:10px; justify-content:flex-end;">
        <button onclick="closeDeleteModal()" class="btn-secondary">Cancel</button>
        <button onclick="submitDeleteAccount()" class="btn-danger">Delete My Account</button>
      </div>
    </div>
  </div>

  <script>
    // API Base URL - use current origin to work with any port
    const API_BASE = window.location.origin;

    // Load User Details
    const username = localStorage.getItem("username");
    const userRole = localStorage.getItem("userRole");
    let originalEmail = '';

    // Load profile data on page load
    async function loadProfile() {
      try {
        const token = localStorage.getItem('authToken');
        if (!token) return;

        const resp = await fetch(`${API_BASE}/auth/profile`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (resp.ok) {
          const data = await resp.json();
          document.getElementById('usernameInput').value = data.username;
          document.getElementById('emailInput').value = data.email || '';
          originalEmail = data.email || '';

          // Update sidebar
          document.querySelector('.profile-name').textContent = data.username;
          document.querySelector('.profile-email').textContent = data.email || data.username + '@company.com';

          // Load profile picture
          if (data.profile_picture) {
            document.getElementById('profileImage').src = data.profile_picture;
            document.getElementById('profileImage').style.display = 'block';
            document.getElementById('profileEmoji').style.display = 'none';
            localStorage.setItem('userProfilePicture', data.profile_picture);
          }
        }
      } catch (e) {
        console.error('Failed to load profile:', e);
      }
    }

    if (username) {
      document.querySelector(".profile-name").textContent = username;
      document.querySelector(".profile-email").textContent = username + "@company.com";
      document.getElementById('usernameInput').value = username;

      // Load cached profile picture
      const cachedPicture = localStorage.getItem('userProfilePicture');
      if (cachedPicture) {
        document.getElementById('profileImage').src = cachedPicture;
        document.getElementById('profileImage').style.display = 'block';
        document.getElementById('profileEmoji').style.display = 'none';
      }

      // Admin Check for User Management
      if (userRole === 'admin') {
        document.getElementById('userManagementSection').style.display = 'block';
        loadUsers();
      }

      loadProfile();
    }

    // ============ PROFILE PICTURE UPLOAD ============
    document.getElementById('sidebarProfileImg').addEventListener('click', function () {
      document.getElementById('profilePictureInput').click();
    });

    document.getElementById('profilePictureInput').addEventListener('change', async function (e) {
      const file = e.target.files[0];
      if (!file) return;

      // Validate file type
      if (!file.type.startsWith('image/')) {
        showWarning('Please select an image file', 'Invalid File Type');
        return;
      }

      // Validate file size (max 500KB)
      if (file.size > 500 * 1024) {
        showWarning('Image too large. Maximum size is 500KB', 'File Too Large');
        return;
      }

      // Read and convert to base64
      const reader = new FileReader();
      reader.onload = async function (event) {
        const base64Data = event.target.result;

        // Preview immediately
        document.getElementById('profileImage').src = base64Data;
        document.getElementById('profileImage').style.display = 'block';
        document.getElementById('profileEmoji').style.display = 'none';

        // Upload to server
        try {
          const token = localStorage.getItem('authToken');
          const resp = await fetch(`${API_BASE}/auth/profile/picture`, {
            method: 'POST',
            headers: {
              'Authorization': 'Bearer ' + token,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({ picture: base64Data })
          });

          const data = await resp.json();
          if (resp.ok) {
            localStorage.setItem('userProfilePicture', base64Data);
            showSuccess('Profile picture updated successfully!', 'Update Saved');
          } else {
            showError('Error: ' + (data.error || 'Failed to update picture'), 'Update Failed');
          }
        } catch (err) {
          showError('Error: ' + err.message, 'Connection Error');
        }
      };
      reader.readAsDataURL(file);
    });

    // ============ SAVE CHANGES ============
    // ============ SAVE CHANGES ============
    document.getElementById('saveChangesBtn').addEventListener('click', async function () {
      const email = document.getElementById('emailInput').value.trim();

      if (!email) {
        showWarning('Please enter an email address', 'Missing Information');
        return;
      }

      try {
        const token = localStorage.getItem('authToken');
        const resp = await fetch(`${API_BASE}/auth/profile`, {
          method: 'PUT',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ email: email })
        });

        const data = await resp.json();
        if (resp.ok) {
          showSuccess('Profile updated successfully!', 'Changes Saved');
          originalEmail = email;
          // Store in localStorage so other pages can read it
          localStorage.setItem('userEmail', email);
          document.querySelector('.profile-email').textContent = email;
        } else {
          showError('Error: ' + (data.error || 'Failed to update profile'), 'Update Failed');
        }
      } catch (e) {
        showError('Error: ' + e.message, 'Connection Error');
      }
    });

    // ============ CANCEL ============
    document.getElementById('cancelBtn').addEventListener('click', function () {
      // Reset email to original value
      document.getElementById('emailInput').value = originalEmail;
    });

    // ============ CHANGE PASSWORD ============
    document.getElementById('changePasswordBtn').addEventListener('click', function () {
      document.getElementById('passwordModal').style.display = 'flex';
      document.getElementById('currentPassword').value = '';
      document.getElementById('newPassword').value = '';
      document.getElementById('confirmPassword').value = '';
    });

    function closePasswordModal() {
      document.getElementById('passwordModal').style.display = 'none';
    }

    async function submitPasswordChange() {
      const current = document.getElementById('currentPassword').value;
      const newPwd = document.getElementById('newPassword').value;
      const confirm = document.getElementById('confirmPassword').value;

      if (!current || !newPwd || !confirm) {
        showWarning('Please fill in all password fields', 'Missing Information');
        return;
      }

      if (newPwd !== confirm) {
        showWarning('New passwords do not match', 'Mismatch');
        return;
      }

      if (newPwd.length < 12) {
        showWarning('Password must be at least 12 characters', 'Password too short');
        return;
      }

      try {
        const token = localStorage.getItem('authToken');
        const resp = await fetch(`${API_BASE}/auth/change-password`, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            current_password: current,
            new_password: newPwd
          })
        });

        const data = await resp.json();
        if (resp.ok) {
          closePasswordModal();
          showSuccess('Password changed successfully!', 'Success');
        } else {
          showError('Error: ' + (data.error || 'Failed to change password'), 'Update Failed');
        }
      } catch (e) {
        showError('Error: ' + e.message, 'Connection Error');
      }
    }

    // ============ VIEW HISTORY ============
    document.getElementById('viewHistoryBtn').addEventListener('click', async function () {
      document.getElementById('historyModal').style.display = 'flex';
      document.getElementById('historyContent').innerHTML = '<div style="text-align:center; color:#666;">Loading...</div>';

      try {
        const token = localStorage.getItem('authToken');
        const resp = await fetch(`${API_BASE}/auth/history`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (resp.ok) {
          const data = await resp.json();
          renderHistory(data.history);
        } else {
          document.getElementById('historyContent').innerHTML = '<div style="color:#e74c3c;">Failed to load history</div>';
        }
      } catch (e) {
        document.getElementById('historyContent').innerHTML = '<div style="color:#e74c3c;">Error: ' + e.message + '</div>';
      }
    });

    function renderHistory(history) {
      const container = document.getElementById('historyContent');
      if (!history || history.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#666; padding:20px;">No login history found</div>';
        return;
      }

      let html = '<table style="width:100%; border-collapse:collapse;">';
      html += '<thead><tr style="background:#f8f9fa;"><th style="padding:10px; text-align:left; border-bottom:2px solid #dee2e6;">Date & Time</th><th style="padding:10px; text-align:left; border-bottom:2px solid #dee2e6;">IP Address</th><th style="padding:10px; text-align:left; border-bottom:2px solid #dee2e6;">Status</th></tr></thead><tbody>';

      history.forEach(h => {
        const statusColor = h.status === 'success' ? '#27ae60' : '#e74c3c';
        const statusText = h.status === 'success' ? '✓ Success' : '✗ Failed';
        const date = new Date(h.login_at).toLocaleString();
        html += `<tr><td style="padding:10px; border-bottom:1px solid #eee;">${date}</td><td style="padding:10px; border-bottom:1px solid #eee;">${h.ip_address}</td><td style="padding:10px; border-bottom:1px solid #eee; color:${statusColor};">${statusText}</td></tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    function closeHistoryModal() {
      document.getElementById('historyModal').style.display = 'none';
    }

    // ============ EXPORT ============
    // ============ EXPORT ============
    document.getElementById('exportBtn').addEventListener('click', async function () {
      try {
        const token = localStorage.getItem('authToken');
        const resp = await fetch(`${API_BASE}/auth/export`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (resp.ok) {
          const blob = await resp.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = 'safecomply_export.json';
          document.body.appendChild(a);
          a.click();
          window.URL.revokeObjectURL(url);
          a.remove();
          showSuccess('Data exported successfully!', 'Export Complete');
        } else {
          const data = await resp.json();
          showError('Error: ' + (data.error || 'Failed to export data'), 'Export Failed');
        }
      } catch (e) {
        showError('Error: ' + e.message, 'Connection Error');
      }
    });

    // ============ DELETE ACCOUNT ============
    document.getElementById('deleteAccountBtn').addEventListener('click', function () {
      // Check if admin
      if (username === 'admin') {
        showWarning('Cannot delete the main admin account', 'Action Not Allowed');
        return;
      }
      document.getElementById('deleteModal').style.display = 'flex';
      document.getElementById('deletePassword').value = '';
    });

    function closeDeleteModal() {
      document.getElementById('deleteModal').style.display = 'none';
    }

    async function submitDeleteAccount() {
      const password = document.getElementById('deletePassword').value;

      if (!password) {
        showWarning('Please enter your password to confirm', 'Missing Password');
        return;
      }

      if (!await showDangerConfirm('Are you absolutely sure? This will permanently delete your account and all data.', 'Delete Account?')) {
        return;
      }

      try {
        const token = localStorage.getItem('authToken');
        const resp = await fetch(`${API_BASE}/auth/delete-account`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Bearer ' + token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ password: password })
        });

        const data = await resp.json();
        if (resp.ok) {
          await showSuccess('Account deleted successfully. You will be redirected to the login page.', 'Account Deleted');
          localStorage.clear();
          window.location.href = 'signin.html';
        } else {
          showError('Error: ' + (data.error || 'Failed to delete account'), 'Deletion Failed');
        }
      } catch (e) {
        showError('Error: ' + e.message, 'Connection Error');
      }
    }

    // ============ ADMIN: LOAD USERS ============
    async function loadUsers() {
      try {
        const token = localStorage.getItem('authToken');
        const resp = await fetch(`${API_BASE}/admin/users`, {
          headers: { 'Authorization': 'Bearer ' + token }
        });

        if (resp.ok) {
          const data = await resp.json();
          renderUsers(data.users);
        } else {
          console.error("Failed to load users");
        }
      } catch (e) {
        console.error(e);
      }
    }

    function renderUsers(users) {
      const container = document.getElementById('userListContainer');
      if (!users || users.length === 0) {
        container.innerHTML = '<div style="padding:15px; text-align:center;">No users found.</div>';
        return;
      }

      let html = '';
      users.forEach(u => {
        html += `
            <div class="setting-item">
              <div class="setting-info">
                <div class="setting-label">${u.username} <span style="font-size:11px; background:#eee; padding:2px 6px; border-radius:4px; margin-left:5px;">${u.role}</span></div>
                <div class="setting-description">ID: ${u.id}</div>
              </div>
              <div class="setting-control">
                ${u.username !== 'admin' ?
            `<button class="btn-danger" style="padding: 5px 15px; font-size: 12px;" onclick="deleteUser('${u.username}')">Delete</button>`
            : '<span style="color:#999; font-size:12px;">Main Admin</span>'}
              </div>
            </div>`;
      });
      container.innerHTML = html;
    }

    async function deleteUser(username) {
      if (!await showDangerConfirm(`Are you sure you want to delete user '${username}'? This cannot be undone.`, 'Delete User?')) return;

      try {
        const token = localStorage.getItem('authToken');
        const resp = await fetch(`${API_BASE}/admin/users/${username}`, {
          method: 'DELETE',
          headers: { 'Authorization': 'Bearer ' + token }
        });

        const data = await resp.json();
        if (resp.ok) {
          await showSuccess(data.message, 'User Deleted');
          loadUsers(); // Reload list
        } else {
          showError('Error: ' + (data.error || 'Failed to delete'), 'Deletion Failed');
        }
      } catch (e) {
        showError('Error: ' + e.message, 'Connection Error');
      }
    }

    // ============ TOGGLE SWITCH ============
    function toggleSwitch(element) {
      element.classList.toggle("active");

      const settingItem = element.closest(".setting-item");
      const label = settingItem.querySelector(".setting-label");

      if (label && label.textContent === "Dark Mode") {
        document.body.classList.toggle("dark-mode");
        const isDarkMode = document.body.classList.contains("dark-mode");
        localStorage.setItem("darkMode", isDarkMode);
      }
    }

    // ============ DARK MODE INIT ============
    window.addEventListener("DOMContentLoaded", function () {
      const isDarkMode = localStorage.getItem("darkMode") === "true";
      if (isDarkMode) {
        document.body.classList.add("dark-mode");
        const settingItems = document.querySelectorAll(".setting-item");
        settingItems.forEach((item) => {
          const label = item.querySelector(".setting-label");
          if (label && label.textContent === "Dark Mode") {
            const toggle = item.querySelector(".toggle-switch");
            if (toggle) {
              toggle.classList.add("active");
            }
          }
        });
      }
    });

    // ============ LOGOUT ============
    document
      .querySelector(".logout-btn")
      .addEventListener("click", async function (e) {
        e.preventDefault();
        if (await showConfirm("Are you sure you want to logout?", "Confirm Logout")) {
          localStorage.clear();
          window.location.href = "signin.html";
        }
      });

    // ============ CLOSE MODALS ON OUTSIDE CLICK ============
    document.getElementById('passwordModal').addEventListener('click', function (e) {
      if (e.target === this) closePasswordModal();
    });
    document.getElementById('historyModal').addEventListener('click', function (e) {
      if (e.target === this) closeHistoryModal();
    });
    document.getElementById('deleteModal').addEventListener('click', function (e) {
      if (e.target === this) closeDeleteModal();
    });
  </script>
  <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
  <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
  <script src="{{ url_for('static', filename='js/password-toggle.js') }}"></script>
  <style>
    /* Notification Styles */
    .header-actions {
      display: flex;
      gap: 15px;
      align-items: center;
      position: relative;
    }

    .notification-dropdown {
      position: absolute;
      top: 60px;
      right: 0;
      width: 320px;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      z-index: 1000;
      overflow: hidden;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-10px);
      transition: all 0.3s ease;
      border: 1px solid #edf2f7;
    }

    .notification-dropdown.active {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .notification-header {
      padding: 15px 20px;
      border-bottom: 1px solid #f1f3f5;
      font-weight: 600;
      color: #2c3e50;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .notification-item {
      padding: 15px 20px;
      border-bottom: 1px solid #f8f9fa;
      transition: background 0.2s;
      cursor: pointer;
    }

    .notification-item:hover {
      background: #f8f9fa;
    }

    .notif-title {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .notif-desc {
      font-size: 12px;
      color: #6c757d;
      line-height: 1.4;
    }

    .notification-badge {
      position: absolute;
      top: -5px;
      right: -5px;
      background: #e74c3c;
      color: white;
      font-size: 10px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid white;
    }
  </style>
</body>

</html>