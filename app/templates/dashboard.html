<!DOCTYPE html>
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compliance Dashboard</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/variables.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
  <link rel="stylesheet" href="{{ url_for('static', filename='css/modal.css') }}" />
</head>

<body>
  <div class="dashboard-wrapper">
    <div class="sidebar">
      <div class="profile-section">
        <div class="profile-img" style="overflow:hidden;">
          <img id="profileImage" src=""
            style="width:100%; height:100%; object-fit:cover; display:none; border-radius:50%;" />
          <span id="profileEmoji">üë§</span>
        </div>
        <div class="profile-name">Admin</div>
        <div class="profile-email">admin@company.com</div>
      </div>

      <a href="dashboard.html" class="menu-item active">
        <span>üìä</span>
        <span>Dashboard</span>
      </a>
      <a href="password-policies.html" class="menu-item">
        <span>üîê</span>
        <span>Password Policies</span>
      </a>
      <a href="backup-policies.html" class="menu-item">
        <span>üíæ</span>
        <span>Backup Policies</span>
      </a>
      <a href="reports.html" class="menu-item">
        <span>üìÑ</span>
        <span>Reports</span>
      </a>
      <a href="recommendations.html" class="menu-item">
        <span>üí°</span>
        <span>Recommendations</span>
      </a>
      <a href="settings.html" class="menu-item">
        <span>‚öôÔ∏è</span>
        <span>Settings</span>
      </a>

      <div class="bottom-menu">
        <a href="#" class="menu-item logout-btn">
          <span>üö™</span>
          <span>Logout</span>
        </a>
      </div>
    </div>

    <div class="main-content">
      <div class="top-header">
        <div class="welcome-text">Welcome Admin!</div>
        <div class="header-actions">
          <input type="text" class="search-box" placeholder="Search..." />
          <div style="position: relative;">
            <button class="icon-btn" id="notif-btn">
              üîî
              <span class="notification-badge">3</span>
            </button>
            <div class="notification-dropdown" id="notif-dropdown">
              <div class="notification-header">
                <span>Notifications</span>
                <span id="mark-read-btn" style="font-size: 11px; color: #3498db; cursor: pointer;">Mark all as
                  read</span>
              </div>
              <div class="notification-list">
                <!-- Dynamic Content Loads Here -->
              </div>
            </div>
          </div>
          <button class="icon-btn">üåô</button>
        </div>
      </div>

      <div class="content-area">
        <div class="section-title">Overview</div>

        <div class="stats-row">
          <div class="stat-box">
            <div class="stat-icon blue"></div>
            <div class="stat-info">
              <div class="stat-number">82%</div>
              <div class="stat-label">Compliance Rate</div>
            </div>
          </div>

          <div class="stat-box">
            <div class="stat-icon orange"></div>
            <div class="stat-info">
              <div class="stat-number">8</div>
              <div class="stat-label">Active Alerts</div>
            </div>
          </div>

          <div class="stat-box">
            <div class="stat-icon green"></div>
            <div class="stat-info">
              <div class="stat-number">3</div>
              <div class="stat-label">Pending Reports</div>
            </div>
          </div>
        </div>

        <div class="content-grid">
          <div class="content-card">
            <div class="card-header">
              <div class="card-title">Policies & Compliance Status</div>
              <a href="policies.html" class="card-action">View All</a>
            </div>
            <div class="card-content" style="
                  display: flex;
                  align-items: center;
                  justify-content: center;
                  flex-direction: column;
                  gap: 15px;
                ">
              <div style="
                    position: relative;
                    width: 180px;
                    height: 180px;
                    margin-bottom: 10px;
                  ">
                <svg viewBox="0 0 200 200" style="transform: rotate(-90deg)">
                  <circle cx="100" cy="100" r="80" fill="none" stroke="#5a7a99" stroke-width="25"
                    stroke-dasharray="342.12" stroke-dashoffset="109.48" stroke-linecap="butt" />
                  <circle cx="100" cy="100" r="80" fill="none" stroke="#c4d0dd" stroke-width="25"
                    stroke-dasharray="342.12" stroke-dashoffset="451.6" stroke-linecap="butt" />
                </svg>
                <div style="
                      position: absolute;
                      top: 130px;
                      left: 10px;
                      text-align: center;
                    ">
                  <span style="font-size: 20px; font-weight: bold; color: #000000">68%</span>
                </div>
                <div style="
                      position: absolute;
                      top: 5px;
                      right: 15px;
                      text-align: center;
                    ">
                  <span style="font-size: 20px; font-weight: bold; color: #000000">32%</span>
                </div>
              </div>
              <div style="display: flex; gap: 20px; align-items: center">
                <div style="display: flex; align-items: center; gap: 8px">
                  <div style="
                        width: 14px;
                        height: 14px;
                        background: #c4d0dd;
                        border-radius: 3px;
                      "></div>
                  <span style="font-size: 12px; color: #6c757d">Backup Policy</span>
                </div>
                <div style="display: flex; align-items: center; gap: 8px">
                  <div style="
                        width: 14px;
                        height: 14px;
                        background: #5a7a99;
                        border-radius: 3px;
                      "></div>
                  <span style="font-size: 12px; color: #6c757d">Password Policy</span>
                </div>
              </div>
            </div>
          </div>

          <div class="content-card">
            <div class="card-header">
              <div class="card-title">Alerts</div>
              <span style="
                    background: #fee2e2;
                    color: #991b1b;
                    padding: 3px 8px;
                    border-radius: 10px;
                    font-size: 11px;
                    font-weight: 600;
                  ">8</span>
            </div>
            <div class="card-content">
              <div class="alert-card high">
                <div class="alert-top">
                  <div class="alert-text">
                    <div class="alert-title">Nightly Backup Failed</div>
                    <div class="alert-desc">Main server backup failed</div>
                  </div>
                </div>
                <div class="alert-bottom">
                  <span class="alert-badge high">High</span>
                  <span class="alert-time">2 hours ago</span>
                </div>
              </div>

              <div class="alert-card medium">
                <div class="alert-top">
                  <div class="alert-text">
                    <div class="alert-title">Unauthorized Login Attempt</div>
                    <div class="alert-desc">5 failed login attempts</div>
                  </div>
                </div>
                <div class="alert-bottom">
                  <span class="alert-badge medium">Medium</span>
                  <span class="alert-time">4 hours ago</span>
                </div>
              </div>

              <div class="alert-card high">
                <div class="alert-top">
                  <div class="alert-text">
                    <div class="alert-title">Weak Password Detected</div>
                    <div class="alert-desc">3 weak passwords found</div>
                  </div>
                </div>
                <div class="alert-bottom">
                  <span class="alert-badge high">High</span>
                  <span class="alert-time">6 hours ago</span>
                </div>
              </div>

              <div class="alert-card low">
                <div class="alert-top">
                  <div class="alert-text">
                    <div class="alert-title">Policy Update Required</div>
                    <div class="alert-desc">Backup policy needs review</div>
                  </div>
                </div>
                <div class="alert-bottom">
                  <span class="alert-badge low">Low</span>
                  <span class="alert-time">1 day ago</span>
                </div>
              </div>
            </div>
          </div>

          <div class="content-card">
            <div class="card-header">
              <div class="card-title">Reports</div>
              <a href="reports.html" class="card-action">+ Create Report</a>
            </div>
            <div class="card-content">
              <div class="report-card">
                <div class="report-left">
                  <span class="report-icon">üìã</span>
                  <div>
                    <div class="report-title">Monthly Compliance Report</div>
                    <div class="report-date">2024-11-01</div>
                  </div>
                </div>
                <div class="report-right">
                  <span class="report-status ready">Ready</span>
                  <div class="download-icon">‚¨áÔ∏è</div>
                </div>
              </div>

              <div class="report-card">
                <div class="report-left">
                  <span class="report-icon">üìã</span>
                  <div>
                    <div class="report-title">Quarterly Risk Analysis</div>
                    <div class="report-date">2024-10-01</div>
                  </div>
                </div>
                <div class="report-right">
                  <span class="report-status ready">Ready</span>
                  <div class="download-icon">‚¨áÔ∏è</div>
                </div>
              </div>

              <div class="report-card">
                <div class="report-left">
                  <span class="report-icon">üìã</span>
                  <div>
                    <div class="report-title">Internal Audit Report</div>
                    <div class="report-date">2024-11-15</div>
                  </div>
                </div>
                <div class="report-right">
                  <span class="report-status processing">Processing</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Load Dashboard Stats
    async function loadDashboardStats() {
      // Personalize Welcome Message
      const username = localStorage.getItem("username");
      const userEmail = localStorage.getItem("userEmail");
      const userPicture = localStorage.getItem("userProfilePicture");
      if (username) {
        document.querySelector(".profile-name").textContent = username;
        document.querySelector(".profile-email").textContent = userEmail || username + "@company.com";
        document.querySelector(".welcome-text").textContent = "Welcome " + username + "!";

        // Load profile picture
        if (userPicture) {
          document.getElementById('profileImage').src = userPicture;
          document.getElementById('profileImage').style.display = 'block';
          document.getElementById('profileEmoji').style.display = 'none';
        }
      }

      try {
        const token = localStorage.getItem('authToken');
        const headers = token ? { 'Authorization': 'Bearer ' + token } : {};

        const resp = await fetch('http://localhost:5002/dashboard-stats', { headers });
        if (!resp.ok) {
          if (resp.status === 401) window.location.href = 'signin.html';
          return;
        }
        const data = await resp.json();

        // Update Overview Stats
        document.querySelector('.stat-box:nth-child(1) .stat-number').textContent = data.compliance_rate + '%';
        document.querySelector('.stat-box:nth-child(2) .stat-number').textContent = data.active_alerts;
        document.querySelector('.stat-box:nth-child(3) .stat-number').textContent = data.pending_reports;

        // Update Pie Chart Data (Visual only for now, text update)
        const pwd = data.policy_breakdown.password;
        const backup = data.policy_breakdown.backup;

        // Update the SVG stroke-dasharray if you want dynamic charts, 
        // but for now let's just update the text labels if they exist or just the central number.
        // The SVG is hardcoded, so we will leave it for now or implement a real chart lib if requested.
        // We will just update the central percentage to average compliance.
        const centerText = document.querySelector('.card-content span[style*="font-size: 20px"]');
        if (centerText) centerText.textContent = data.compliance_rate + '%';

      } catch (e) {
        console.error('Failed to load stats', e);
      }
    }

    loadDashboardStats();

    // Dark mode
    if (localStorage.getItem("darkMode") === "true") {
      document.body.classList.add("dark-mode");
      const moonBtn = document.querySelectorAll(".icon-btn")[1];
      if (moonBtn) moonBtn.textContent = "‚òÄÔ∏è";
    }

    const moonBtns = document.querySelectorAll(".icon-btn");
    // Handled individually now to avoid confusion, but keeping dark mode on the specific moon button (index related or class)
    // The previous code selected buttons by index. Since we added a wrapper, querySelectorAll should still work but let's be more specific.

    // Dark Mode Toggle (targeting the Moon button specifically)
    // We can rely on the last icon-btn or add an ID to be safe, but let's stick to the existing approach or simply find the one with the moon icon.
    // The previous code used moonBtns[1]. Since we didn't add more .icon-btn elements (just wrapped one), the indexing might still hold 
    // BUT we changed the structure. 
    // The first .icon-btn is the Bell (inside div). The second is Moon.
    // So current code moonBtns[1] should still work.
    if (moonBtns[1]) {
      moonBtns[1].addEventListener("click", function () {
        document.body.classList.toggle("dark-mode");
        const isDark = document.body.classList.contains("dark-mode");
        localStorage.setItem("darkMode", isDark);
        this.textContent = isDark ? "‚òÄÔ∏è" : "üåô";
      });
    }

    // Logout
    document
      .querySelector(".logout-btn")
      .addEventListener("click", async function (e) {
        e.preventDefault();
        if (await showConfirm("Are you sure you want to logout?", "Confirm Logout")) {
          localStorage.clear();
          window.location.href = "signin.html";
        }
      });
  </script>
  <script src="{{ url_for('static', filename='js/modal.js') }}"></script>
  <script src="{{ url_for('static', filename='js/notifications.js') }}"></script>
</body>

</html>